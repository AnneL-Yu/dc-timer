<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間BOSS戰</title>
    <style>
        :root { --primary: #00f2ff; --warn: #ff0000; --bg: #050505; --card: #111; --disabled: #222; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 90%; max-width: 450px; text-align: center; }
        
        .timer-display { 
            font-size: clamp(80px, 25vw, 140px); font-weight: 900; margin: 40px 0; 
            color: var(--primary); text-shadow: 0 0 20px var(--primary);
            font-family: 'Courier New', monospace; transition: opacity 0.1s;
        }
        .over-text { color: var(--warn) !important; text-shadow: 0 0 30px var(--warn) !important; }

        #login-screen { background: var(--card); padding: 40px 20px; border-radius: 24px; border: 1px solid var(--primary); }
        #player-ui, #admin-ui { display: none; width: 100%; }

        .result-list { background: var(--card); border-radius: 16px; padding: 15px; margin-top: 20px; text-align: left; border: 1px solid #333; }
        .result-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #222; font-size: 18px; }
        .result-row:last-child { border: none; }
        .bust-name { color: var(--warn); font-weight: bold; }

        button { padding: 20px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; width: 100%; transition: all 0.2s; margin: 10px 0; }
        #stop-btn { background: var(--primary); color: black; }
        #stop-btn:disabled { background: var(--disabled) !important; color: #444 !important; cursor: not-allowed; transform: scale(0.98); }

        #start-btn { background: #00ff88; color: black; font-size: 22px; }
        #reset-btn { background: transparent; color: #666; border: 1px solid #333; }
        input { width: 85%; padding: 15px; border-radius: 8px; border: 1px solid #333; background: #000; color: white; text-align: center; margin-bottom: 20px; font-size: 18px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h1 style="color:var(--primary); letter-spacing: 2px; margin-bottom: 30px;">時間BOSS戰</h1>
        <input type="text" id="username" placeholder="請輸入名字" maxlength="10">
        <button id="join-btn" style="background:var(--primary)">進入房間</button>
    </div>

    <div id="player-ui">
        <div id="status-text" style="color: #666;">等待發號施令...</div>
        <div id="player-timer" class="timer-display">0.00</div>
        <button id="stop-btn" disabled>STOP</button>
        <div id="wait-msg" style="display:none; color:var(--primary); margin-top:20px;">成績已鎖定，請等待開獎</div>
    </div>

    <div id="admin-ui">
        <div style="color: yellow; letter-spacing: 1px;">主控台計時同步中</div>
        <div id="admin-timer" class="timer-display">0.00</div>
        <button id="start-btn">開始遊戲</button>
        <button id="reset-btn">清空所有紀錄</button>
        <div class="result-list">
            <div style="color:#555; font-size:12px; margin-bottom:10px;">即時成績清單</div>
            <div id="admin-results-list"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCOEILTMCYOWf8QUdVQP4DPwih-4_Ymo2w",
        authDomain: "dc26-effda.firebaseapp.com",
        databaseURL: "https://dc26-effda-default-rtdb.firebaseio.com",
        projectId: "dc26-effda",
        storageBucket: "dc26-effda.firebasestorage.app",
        messagingSenderId: "933151619542",
        appId: "1:933151619542:web:5744cc69677634d3628c77"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const stateRef = ref(db, 'game_state');
    const resultsRef = ref(db, 'results');

    const isAdmin = new URLSearchParams(window.location.search).has('admin');
    const loginScreen = document.getElementById('login-screen');
    const playerUI = document.getElementById('player-ui');
    const adminUI = document.getElementById('admin-ui');
    const stopBtn = document.getElementById('stop-btn');
    
    let currentName = localStorage.getItem('dc_player_name') || "";
    let gameInterval;
    let localStartTime = 0;
    let hasSubmitted = false;

    const playSound = (freq, duration, type = 'sine') => {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    };

    // 初始化介面
    if (isAdmin) {
        loginScreen.style.display = 'none';
        adminUI.style.display = 'block';
    } else if (currentName) {
        loginScreen.style.display = 'none';
        playerUI.style.display = 'block';
    }

    document.getElementById('join-btn').onclick = () => {
        const name = document.getElementById('username').value.trim();
        if(!name) return alert("請輸入名字");
        currentName = name;
        localStorage.setItem('dc_player_name', name);
        loginScreen.style.display = 'none';
        playerUI.style.display = 'block';
    };

    onValue(stateRef, (snapshot) => {
        const state = snapshot.val();
        if(state?.status === 'playing') {
            localStartTime = state.startTime;
            checkIfAlreadySubmitted().then(submitted => {
                hasSubmitted = submitted;
                if (!hasSubmitted) {
                    startSyncTimer(localStartTime);
                } else {
                    lockPlayerUI();
                }
            });
        } else {
            resetGlobalUI();
        }
    });

    async function checkIfAlreadySubmitted() {
        if (isAdmin) return false;
        const snap = await get(resultsRef);
        let found = false;
        if (snap.exists()) {
            snap.forEach(child => {
                if (child.val().name === currentName) found = true;
            });
        }
        return found;
    }

    function startSyncTimer(startTime) {
        const timerID = isAdmin ? 'admin-timer' : 'player-timer';
        const display = document.getElementById(timerID);
        
        if (!isAdmin) {
            stopBtn.disabled = false;
            stopBtn.innerText = "STOP";
            document.getElementById('status-text').innerText = "遊戲進行中...";
        }
        document.getElementById('wait-msg').style.display = 'none';
        display.classList.remove('over-text');
        
        clearInterval(gameInterval);
        gameInterval = setInterval(() => {
            const elapsed = (Date.now() - startTime) / 1000;
            
            if (elapsed <= 5) {
                display.innerText = elapsed.toFixed(2);
                display.style.opacity = "1";
            } else if (elapsed <= 10) {
                display.innerText = elapsed.toFixed(2);
                display.style.opacity = (1 - (elapsed - 5) / 5).toString();
            } else if (elapsed < 65) {
                display.innerText = "---";
                display.style.opacity = "1";
            } else {
                display.innerText = "OVER";
                display.classList.add('over-text');
                if (!isAdmin && !hasSubmitted) {
                    playSound(150, 0.8, 'sawtooth');
                    stopBtn.disabled = true;
                    stopBtn.innerText = "BUSTED";
                    uploadResult(elapsed, true);
                    hasSubmitted = true;
                }
                clearInterval(gameInterval);
            }
        }, 50);
    }

    function lockPlayerUI() {
        clearInterval(gameInterval);
        document.getElementById('player-timer').innerText = "LOCKED";
        stopBtn.disabled = true;
        stopBtn.innerText = "LOCKED";
        document.getElementById('wait-msg').style.display = 'block';
    }

    function resetGlobalUI() {
        clearInterval(gameInterval);
        hasSubmitted = false;
        const displays = document.querySelectorAll('.timer-display');
        displays.forEach(d => {
            d.innerText = "0.00";
            d.style.opacity = "1";
            d.classList.remove('over-text');
        });
        if (!isAdmin) {
            stopBtn.disabled = true;
            stopBtn.innerText = "STOP";
            document.getElementById('wait-msg').style.display = 'none';
            document.getElementById('status-text').innerText = "等待發號施令...";
        } else {
            document.getElementById('admin-results-list').innerHTML = "";
        }
    }

    stopBtn.onclick = () => {
        if (hasSubmitted) return;
        const stopTime = Date.now();
        const finalElapsed = (stopTime - localStartTime) / 1000;
        hasSubmitted = true;
        lockPlayerUI();
        playSound(1000, 0.2, 'sine');
        uploadResult(finalElapsed, false);
    };

    function uploadResult(time, bust) {
        push(resultsRef, { 
            name: currentName, 
            time: time, 
            bust: bust, 
            diff: Math.abs(60 - time),
            ts: Date.now() 
        });
    }

    onValue(resultsRef, (snapshot) => {
        if (!isAdmin) return;
        const list = document.getElementById('admin-results-list');
        list.innerHTML = "";
        const results = [];
        snapshot.forEach(child => { results.push(child.val()); });
        results.sort((a, b) => a.diff - b.diff);
        results.forEach(r => {
            const row = document.createElement('div');
            row.className = 'result-row';
            row.innerHTML = `<span class="${r.bust ? 'bust-name' : ''}">${r.name}</span><span style="color:${r.bust ? '#ff0000' : '#00ff88'}">${r.time.toFixed(3)}s</span>`;
            list.appendChild(row);
        });
    });

    document.getElementById('start-btn').onclick = () => {
        remove(resultsRef);
        set(stateRef, { status: 'playing', startTime: Date.now() });
    };

    document.getElementById('reset-btn').onclick = () => {
        remove(resultsRef);
        set(stateRef, { status: 'waiting' });
    };
</script>
</body>
</html>


